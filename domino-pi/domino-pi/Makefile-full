#
# Copyright (C) 2013 OpenWrt.org
#
# This is free software, licensed under the GNU General Public License v2.
# See /LICENSE for more information.
#

include $(TOPDIR)/rules.mk

PKG_NAME:=gl-inet
PKG_REFV:=2
PKG_RELEASE:=1

include $(INCLUDE_DIR)/package.mk

define Package/gl-inet
  SECTION:=base
  CATEGORY:=gl-inet
  TITLE:=GL iNet services
# DEPENDS:=+libpthread $(INTL_DEPENDS) $(ICONV_DEPENDS) +ethtool 
  DEPENDS:=+libpthread +ethtool +blkid +miniupnpc +fcgi +libubox +iwinfo\
   +kmod-fs-ext4 +kmod-fs-ntfs +kmod-fs-vfat +kmod-fs-ext4 +ntfs-3g \
   +kmod-nls-cp437 +kmod-nls-iso8859-1 +kmod-nls-utf8 \
   +kmod-usb-storage +kmod-usb-uhci +kmod-usb2 +kmod-usb-ohci \
   +kmod-usb-net +kmod-usb-cdc-ether +kmod-usb-net-rndis \
   +kmod-usb-serial +kmod-usb-serial-cp210x +kmod-usb-serial-option +kmod-usb-serial-wwan +kmod-usb-acm +usb-modeswitch +usb-modeswitch-data \
   +comgt +chat \
   +kmod-video-core +kmod-video-uvc +kmod-video-gspca-core +kmod-video-gspca-zc3xx +kmod-video-gspca-sonixb ++kmod-video-gspca-sonixj \
   +@BUSYBOX_CUSTOM +@BUSYBOX_CONFIG_UNICODE_SUPPORT \
   +@BUSYBOX_CONFIG_UNICODE_COMBINING_WCHARS +@BUSYBOX_CONFIG_UNICODE_WIDE_WCHARS +@BUSYBOX_CONFIG_UNICODE_BIDI_SUPPORT +@BUSYBOX_CONFIG_UNICODE_NEUTRAL_TABLE +@BUSYBOX_CONFIG_UNICODE_PRESERVE_BROKEN  \
   +@BUSYBOX_CONFIG_FEATURE_WGET_TIMEOUT +@BUSYBOX_CONFIG_FUSER +@BUSYBOX_CONFIG_IPCRM +@BUSYBOX_CONFIG_IPCS \
   +@BUSYBOX_CONFIG_FEATURE_FLOAT_SLEEP
   #+@BUSYBOX_CONFIG_SUBST_WCHAR=63 +@BUSYBOX_CONFIG_LAST_SUPPORT_WCHAR=195101 \

endef

define Build/Prepare
	mkdir -p $(PKG_BUILD_DIR)
	$(CP) ./src/* $(PKG_BUILD_DIR)
endef

define Build/Configure
endef

MAKE_FLAGS += CFLAGS="$(TARGET_CFLAGS) -Wall"

define Package/gl-inet/install
	$(INSTALL_DIR) $(1)/usr/bin
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/xgetd $(1)/usr/bin
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/video_init $(1)/usr/bin
	$(INSTALL_DIR) $(1)/lib
	$(CP) -fr ./files/* $(1)/
	chmod +x $(1)/etc/init.d/firewall_gl $(1)/etc/init.d/ssid $(1)/etc/init.d/xgetd
	chmod +x $(1)/usr/lib/ddns/glddnsupdater.sh $(1)/usr/bin/wifionoff $(1)/usr/bin/glupnpc
	$(INSTALL_DIR) $(1)/www/cgi-bin
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/login_cgi $(1)/www/cgi-bin
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/router_cgi $(1)/www/cgi-bin
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/video_cgi $(1)/www/cgi-bin
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/storage_cgi $(1)/www/cgi-bin
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/firmware_cgi $(1)/www/cgi-bin
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/software_cgi $(1)/www/cgi-bin
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/download_file $(1)/www/cgi-bin
	$(INSTALL_DATA) $(PKG_BUILD_DIR)/libglinet.so $(1)/www/cgi-bin
	$(INSTALL_BIN) $(PKG_BUILD_DIR)/dl $(1)/www/cgi-bin
	chmod +x $(1)/www/cgi-bin/*
	ln -s /www/cgi-bin/libglinet.so $(1)/lib/
endef

$(eval $(call BuildPackage,gl-inet))
